<!DOCTYPE html>
<html>
<head>
    <title>SSA Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        div { margin-top: 10px; padding: 10px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>SSA Upload Test</h1>
    <p>This page tests SSA upload functionality step by step.</p>

    <div>
        <h2>Step 1: Test Backend Connection</h2>
        <button onclick="testBackend()">Test Backend</button>
        <div id="backend-result"></div>
    </div>

    <div>
        <h2>Step 2: Test Upload Endpoint</h2>
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="setToken()">Set Token</button>
        <p>Token: <span id="tokenStatus">Not Set</span></p>
        <button onclick="testUpload()">Test Upload</button>
        <div id="upload-result"></div>
    </div>

    <div>
        <h2>Step 3: Test SSA Creation</h2>
        <button onclick="testSSACreation()">Test SSA Creation</button>
        <div id="ssa-result"></div>
    </div>
    
    <script>
        function setToken() {
            const token = prompt("Enter JWT token:");
            if (token) {
                localStorage.setItem('token', token);
                document.getElementById('tokenStatus').textContent = 'Set';
            }
        }

        async function testBackend() {
            try {
                const response = await fetch('/api/books/health');
                const data = await response.text();
                document.getElementById('backend-result').innerHTML = 
                    '<p class="success">✅ Backend working: ' + data + '</p>';
            } catch (error) {
                document.getElementById('backend-result').innerHTML = 
                    '<p class="error">❌ Backend error: ' + error.message + '</p>';
            }
        }

        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) { alert('Select a file'); return; }
            
            const token = localStorage.getItem('token');
            if (!token) { alert('Set token first'); return; }

            try {
                // Convert to base64
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const requestData = {
                    file: base64Data,
                    filename: file.name,
                    contentType: file.type,
                    uploadType: 'ssa'
                };

                console.log('Sending upload request:', requestData);

                const response = await fetch('/api/books/upload-image-base64', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Upload response status:', response.status);
                console.log('Upload response ok:', response.ok);

                if (response.ok) {
                    const result = await response.text();
                    document.getElementById('upload-result').innerHTML = 
                        '<p class="success">✅ Upload successful: ' + result + '</p>';
                } else {
                    const errorText = await response.text();
                    document.getElementById('upload-result').innerHTML = 
                        '<p class="error">❌ Upload failed: ' + response.status + ' - ' + errorText + '</p>';
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('upload-result').innerHTML = 
                    '<p class="error">❌ Upload error: ' + error.message + '</p>';
            }
        }

        async function testSSACreation() {
            const token = localStorage.getItem('token');
            if (!token) { alert('Set token first'); return; }

            try {
                const ssaData = {
                    title: "Test SSA",
                    bookId: 1, // Replace with actual book ID
                    images: [
                        { imageUrl: "/uploads/ssa/test.jpg", correctPosition: 1 }
                    ]
                };

                const response = await fetch('/api/ssa/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(ssaData)
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('ssa-result').innerHTML = 
                        '<p class="success">✅ SSA creation successful: ' + JSON.stringify(result) + '</p>';
                } else {
                    const errorText = await response.text();
                    document.getElementById('ssa-result').innerHTML = 
                        '<p class="error">❌ SSA creation failed: ' + response.status + ' - ' + errorText + '</p>';
                }
            } catch (error) {
                console.error('SSA creation error:', error);
                document.getElementById('ssa-result').innerHTML = 
                    '<p class="error">❌ SSA creation error: ' + error.message + '</p>';
            }
        }

        // Check token on load
        window.onload = () => {
            if (localStorage.getItem('token')) {
                document.getElementById('tokenStatus').textContent = 'Set';
            }
        };
    </script>
</body>
</html>
